// hash-verify.js – Kopieer pure tekst + Verifieer SHA256 hash
// Gebruikt officialHashes uit official-hashes.js (moet met 'var' of 'window.' gedefinieerd zijn)

// ===== KOPIEER SCHONE PAGINA TEKST (voor hash verificatie) =====
window.copyPageText = function() {
  const mainContent = document.querySelector('.main-content');
  if (!mainContent) return;

  const clone = mainContent.cloneNode(true);

  // Verwijder alles wat NIET bij de pure manifest-tekst hoort
  const unwanted = [
  // Integriteitscheck + UI
  '.integrity-check', '.integrity-content', '.verify-section', '.hash-verifier',
  '.copy-container', '.copy-feedback', '#verify-feedback', '.verify-feedback',

  // Andere secties
  '.community-box', '.donation-section',
  '.footer-nav', '.site-footer', '.site-footer-credits', '.page-footer',

  // Banner & homepage elementen
  '.banner', '.overlay-text', '.home-container', '.language-buttons',
  '.language-selector', '.manifest-header', '.manifest-subtitle',
  '.intro-title', '.intro-text',

  // Alleen buttons, scripts, code en nav verwijderen – links (a) en headings blijven!
  'button', 'script', 'code', 'nav'
];

  clone.querySelectorAll(unwanted.join(', ')).forEach(el => el.remove());

  // Verwijder uitleg over hash verificatie
  clone.querySelectorAll('p').forEach(p => {
    const text = p.textContent.trim();
    if (text.toLowerCase().includes('hash verificatie') || 
        text.toLowerCase().includes('wat is nu eigenlijk hash') ||
        text.includes('waarom zouden we dat doen')) {
      p.remove();
    }
  });

  // Verwijder elementen met "Generated by" of oude JS code
  clone.querySelectorAll('*').forEach(el => {
    const text = el.textContent;
    if (text.includes('Generated by') || 
        text.includes('GitHub Pages') ||
        text.includes('document.addEventListener') ||
        text.includes('officialHashes')) {
      el.remove();
    }
  });

  // Verwijder lege elementen
  clone.querySelectorAll('p, div, section, article').forEach(el => {
    if (el.textContent.trim().length < 5) el.remove();
  });

    // Pure tekst – behoud exacte paragrafen en newlines zoals in officiële hashes
  let text = clone.textContent || clone.innerText || '';

  // Alleen extreme newlines opschonen (meer dan 3 → 2), maar paragraafscheidingen (twee newlines) intact laten
  text = text
    .replace(/\r\n/g, '\n')         // Windows → Unix newlines
    .replace(/\n{3,}/g, '\n\n')      // 3+ lege regels → 2 (voor veiligheid)
    .replace(/[ \t]+/g, ' ')        // meerdere spaties/tabs → één spatie
    .trim();

  // Kopieer naar clipboard
  navigator.clipboard.writeText(text).then(() => {
    showFeedback('copy-feedback', true);
  }).catch(() => {
    showFeedback('copy-feedback', false);
  });
};

// ===== VERIFIEER HASH =====
window.verifyHash = function() {
  const userHash = document.getElementById('user-hash').value.trim().toLowerCase();
  const feedback = document.getElementById('verify-feedback');

  if (!userHash) {
    showFeedback('verify-feedback', false, '✗ Voer een hash in');
    return;
  }

  // Bereken pad zoals in official-hashes.js
 let pagePath = window.location.pathname;
pagePath = pagePath.replace(/\/$/, ''); // trailing slash weg
pagePath = pagePath.replace(/^\/Open_Internet_Manifest/, '');

// Fallbacks voor home/manifiest lijst
if (pagePath === '' || pagePath === '/' || pagePath === '/nl' || pagePath === '/nl/') {
  pagePath = '/nl/manifest';  // of '' afhankelijk van je key
}

  const expectedHash = (typeof officialHashes !== 'undefined' ? officialHashes[pagePath] : null) || 
                       (typeof officialHashes !== 'undefined' ? officialHashes[''] : null);

  const lang = document.documentElement.lang || 'nl';

  if (userHash === (expectedHash || '').toLowerCase()) {
    const matchText = lang === 'en' ? '✓ PERFECTE MATCH!' : '✓ PERFECTE MATCH!';
    const authText = lang === 'en' ? 'Deze pagina is 100% authentiek.' : 'Deze pagina is 100% authentiek.';
    feedback.innerHTML = `<span style="color: #66ff66 !important; font-size: 1.2em; font-weight: bold;">${matchText}</span><br>${authText}`;
  } else {
    const noMatch = lang === 'en' ? '✗ Geen match' : '✗ Geen match';
    const your = lang === 'en' ? 'Jouw hash:' : 'Jouw hash:';
    const official = lang === 'en' ? 'Officiële hash:' : 'Officiële hash:';
    const notFound = lang === 'en' ? 'niet gevonden' : 'niet gevonden';
    feedback.innerHTML = `<span style="color: #ff6666 !important; font-weight: bold;">${noMatch}</span><br>
      <strong>${your}</strong> <code style="word-break: break-all;">${userHash}</code><br>
      <strong>${official}</strong> <code style="word-break: break-all;">${expectedHash || notFound}</code>`;
  }
};

// ===== HULPFUNCTIE VOOR FEEDBACK (minder herhaling) =====
function showFeedback(elementId, success, customText = null) {
  const feedback = document.getElementById(elementId);
  if (!feedback) return;

  const lang = document.documentElement.lang || 'nl';

  if (success) {
    const text = customText || (lang === 'en' ? '✓ Pagina tekst gekopieerd!' : '✓ Pagina tekst gekopieerd!');
    feedback.innerHTML = `<span style="color: #66ff66 !important; font-weight: bold;">${text}</span>`;
    setTimeout(() => feedback.innerHTML = '', 3000);
  } else {
    const text = customText || (lang === 'en' ? 'Copy mislukt – selecteer handmatig' : 'Copy mislukt – selecteer handmatig');
    feedback.innerHTML = `<span style="color: #ff6666 !important;">${text}</span>`;
  }
}