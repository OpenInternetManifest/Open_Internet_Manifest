// hash-verify.js – Kopieer pure tekst + Verifieer SHA256 hash
// Gebruikt officialHashes uit official-hashes.js (moet met 'var' gedefinieerd zijn)

window.copyPageText = function() {
  const mainContent = document.querySelector('.main-content');
  if (!mainContent) return;

  const clone = mainContent.cloneNode(true);

  const unwanted = [
    '.integrity-check', '.integrity-content', '.verify-section', '.hash-verifier',
    '.copy-container', '.copy-feedback', '#verify-feedback', '.verify-feedback',
    '.community-box', '.donation-section',
    '.footer-nav', '.site-footer', '.site-footer-credits', '.page-footer',
    '.banner', '.overlay-text', '.home-container', '.language-buttons',
    '.language-selector', '.manifest-header', '.manifest-subtitle',
    '.intro-title', '.intro-text',
    'button', 'script', 'code', 'nav'
  ];

  clone.querySelectorAll(unwanted.join(', ')).forEach(el => el.remove());

  // Verwijder uitleg over hash
  clone.querySelectorAll('p').forEach(p => {
    const text = p.textContent.trim().toLowerCase();
    if (text.includes('hash verificatie') || text.includes('wat is nu eigenlijk hash')) {
      p.remove();
    }
  });

  // Verwijder "Generated by" etc.
  clone.querySelectorAll('*').forEach(el => {
    const text = el.textContent;
    if (text.includes('Generated by') || text.includes('GitHub Pages')) {
      el.remove();
    }
  });

  // Cleanup lege elementen
  clone.querySelectorAll('p, div, section').forEach(el => {
    if (el.textContent.trim().length < 5) el.remove();
  });

  let text = clone.textContent || clone.innerText || '';
  text = text
    .replace(/\r\n/g, '\n')
    .replace(/\n{3,}/g, '\n\n')
    .replace(/[ \t]+/g, ' ')
    .trim();

  navigator.clipboard.writeText(text).then(() => {
    showFeedback('copy-feedback', true);
  }).catch(() => {
    showFeedback('copy-feedback', false);
  });
};

window.verifyHash = function() {
  const userHash = document.getElementById('user-hash')?.value.trim().toLowerCase();
  const feedback = document.getElementById('verify-feedback');
  if (!feedback) return;

  if (!userHash) {
    showFeedback('verify-feedback', false, '✗ Voer een hash in');
    return;
  }

  if (typeof officialHashes === 'undefined') {
    showFeedback('verify-feedback', false, 'Error: hashes niet geladen');
    return;
  }

  let pagePath = window.location.pathname;
  pagePath = pagePath.replace(/\/$/, '').replace(/^\/Open_Internet_Manifest/, '');

  // Fallback voor home/manifest lijst
  if (pagePath === '' || pagePath === '/' || pagePath === '/nl' || pagePath === '/nl/') {
    pagePath = '/nl/manifest';  // pas aan als je een andere key hebt voor home
  }

  const expectedHash = officialHashes[pagePath] || officialHashes[''] || null;

  const lang = document.documentElement.lang || 'nl';

  if (!expectedHash) {
    showFeedback('verify-feedback', false, 'Officiële hash niet gevonden voor deze pagina.');
    return;
  }

  if (userHash === expectedHash.toLowerCase()) {
    const matchText = lang === 'en' ? '✓ PERFECTE MATCH!' : '✓ PERFECTE MATCH!';
    const authText = lang === 'en' ? 'Deze pagina is 100% authentiek.' : 'Deze pagina is 100% authentiek.';
    feedback.innerHTML = `<span style="color: #66ff66 !important; font-size: 1.2em; font-weight: bold;">${matchText}</span><br>${authText}`;
  } else {
    const noMatch = lang === 'en' ? '✗ Geen match' : '✗ Geen match';
    const your = lang === 'en' ? 'Jouw hash:' : 'Jouw hash:';
    const official = lang === 'en' ? 'Officiële hash:' : 'Officiële hash:';
    feedback.innerHTML = `<span style="color: #ff6666 !important; font-weight: bold;">${noMatch}</span><br>
      <strong>${your}</strong> <code style="word-break: break-all;">${userHash}</code><br>
      <strong>${official}</strong> <code style="word-break: break-all;">${expectedHash}</code>`;
  }
};

function showFeedback(id, success, custom = null) {
  const el = document.getElementById(id);
  if (!el) return;

  const lang = document.documentElement.lang || 'nl';
  let text;

  if (custom) {
    text = custom;
  } else if (success) {
    text = lang === 'en' ? '✓ Pagina tekst gekopieerd!' : '✓ Pagina tekst gekopieerd!';
  } else {
    text = lang === 'en' ? 'Copy mislukt – selecteer handmatig' : 'Copy mislukt – selecteer handmatig';
  }

  el.innerHTML = success && !custom 
    ? `<span style="color: #66ff66 !important; font-weight: bold;">${text}</span>`
    : `<span style="color: #ff6666 !important;">${text}</span>`;

  if (success && !custom) {
    setTimeout(() => el.innerHTML = '', 3000);
  }
}